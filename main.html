<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Übergangs- und Aufgabeergebnis Berechnung</title>
<style>
    body {
        font-family: Arial, sans-serif;
        margin: 0;
        display: grid;
        grid-template-rows: auto 1fr auto; /* Footer will take remaining space */
        min-height: 100vh; /* Ensure the body takes up at least the full viewport height */
    }

    form {
        max-width: 1080px;
        margin: 0 auto;
    }

    .category {
        display: flex;
        align-items: center;
        margin-bottom: 10px;
    }

    .category label {
        margin: 5px;
    }

    .category input[type="text"] {
        width: 420px;
        margin: 5px;
        padding: 8px;
        box-sizing: border-box;
    }

    .category input[type="number"] {
        flex-grow: 0;
        width: 150px; /* Smaller width for number inputs */
        margin: 5px;
        padding: 8px;
        box-sizing: border-box;
    }

    .category input[name="Prozent"] {
        flex-grow: 0;
        width: 90px; /* Smaller width for number inputs */
        margin: 5px;
        padding: 8px;
        box-sizing: border-box;
    }

    .ust-details {
        display: flex;
        align-items: center;
        flex-wrap: wrap;
    }

    .ust-details input {
        flex-grow: 0;
        width: 100px; /* Fixed width for USt percent and Steuerbetrag */
        margin: 5px;
        padding: 8px;
        box-sizing: border-box;
    }

    input[type="checkbox"] {
        margin: 5px 10px 5px 0;
    }

    input[type="submit"] {
        background-color: #4CAF50;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        float: right;
    }

    .custom-file-upload {
        background-color: #3419ac;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        margin-right: 10px;
    }


    .hidden {
        display: none;
    }

    input[name="saveButton"], input[name="importButton"] {
        background-color: #3419ac;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        margin-right: 10px;
    }

    footer {
        background-color: #414141;
        color: #fff;
        padding: 5px;
        text-align: center;
    }
</style>
</head>
<body>

<form id="calcForm">
    <h2>Grunddaten</h2>
    <div class="category">
        <input type="text" id="klientennummer" placeholder="Klientennummer">
    </div>
    <div class="category">
        <input type="text" id="name" placeholder="Name">
    </div>
    <div class="category">
        <input type="text" id="steuernummer" placeholder="Steuernummer">
    </div>
    <div class="category">
        <input type="text" id="straße" placeholder="Straße">
    </div>
    <div class="category">
        <input type="text" id="plz" placeholder="PLZ">
    </div>
    <div class="category">
        <input type="text" id="ort" placeholder="Ort">
    </div>
    
    <h2>Berechnung</h2>
    <select id="berechnung">
        <option value="uebergang">Übergangsergebnis</option>
        <option value="aufgabe">Aufgabeergebnis</option>
        <option value="beides">Beides</option>
    </select>
    
    <div id="uebergang">
        <h3>Übergangsergebnis</h3>
        <h4>Forderungen</h4>
        <div class="category" data-category="forderungen">
            <input type="text" placeholder="Text">
            <input type="number" placeholder="Betrag eingeben">
            <label class="ust-check-label"><input type="checkbox" class="ust-check"> USt</label>
            <div class="ust-details hidden">
                <input type="number" name="Prozent" placeholder="Prozent">
                <input type="number" placeholder="Steuerbetrag">
            </div>
        </div>
        <h4>Verbindlichkeiten</h4>
        <div class="category" data-category="verbindlichkeiten">
            <input type="text" placeholder="Text">
            <input type="number" placeholder="Betrag eingeben">
            <label class="ust-check-label"><input type="checkbox" class="ust-check"> USt</label>
            <div class="ust-details hidden">
                <input type="number" name="Prozent" placeholder="Prozent">
                <input type="number" placeholder="Steuerbetrag">
            </div>
        </div>
        <h4>Rückstellungen</h4>
        <div class="category" data-category="rückstellungen">
            <input type="text" placeholder="Text">
            <input type="number" placeholder="Betrag eingeben">
            <label class="ust-check-label"><input type="checkbox" class="ust-check"> USt</label>
            <div class="ust-details hidden">
                <input type="number" name="Prozent" placeholder="Prozent">
                <input type="number" placeholder="Steuerbetrag">
            </div>
        </div>
        <h4>Bestandsveränderung</h4>
        <div class="category" data-category="bestandsveränderung">
            <input type="text" placeholder="Text">
            <input type="number" placeholder="Betrag eingeben">
            <label class="ust-check-label"><input type="checkbox" class="ust-check"> USt</label>
            <div class="ust-details hidden">
                <input type="number" name="Prozent" placeholder="Prozent">
                <input type="number" placeholder="Steuerbetrag">
            </div>
        </div>
    </div>
    
    <div id="aufgabe" class="hidden">
        <h3>Aufgabeergebnis</h3>
        <h4>Veräußerungserlös</h4>
        <div class="category" data-category="veräußerungserlös">
            <input type="text" placeholder="Text">
            <input type="number" placeholder="Betrag eingeben">
            <label class="ust-check-label"><input type="checkbox" class="ust-check"> USt</label>
            <div class="ust-details hidden">
                <input type="number" name="Prozent" placeholder="Prozent">
                <input type="number" placeholder="Steuerbetrag">
            </div>
        </div>
        <h4>Vom Erwerber übernommene private Schulden</h4>
        <div class="category" data-category="private_schulden">
            <input type="text" placeholder="Text">
            <input type="number" placeholder="Betrag eingeben">
            <label class="ust-check-label"><input type="checkbox" class="ust-check"> USt</label>
            <div class="ust-details hidden">
                <input type="number" name="Prozent" placeholder="Prozent">
                <input type="number" placeholder="Steuerbetrag">
            </div>
        </div>
        <h4>Vom Erwerber übernommene betriebliche Schulden</h4>
        <div class="category" data-category="betriebliche_schulden">
            <input type="text" placeholder="Text">
            <input type="number" placeholder="Betrag eingeben">
            <label class="ust-check-label"><input type="checkbox" class="ust-check"> USt</label>
            <div class="ust-details hidden">
                <input type="number" name="Prozent" placeholder="Prozent">
                <input type="number" placeholder="Steuerbetrag">
            </div>
        </div>
        <h4>Gemeiner Wert der ins PV übernommen Aktiva</h4>
        <div class="category" data-category="gem_wert_aktiva">
            <input type="text" placeholder="Text" data-category="aktiva">
            <input type="number" placeholder="Betrag eingeben">
            <label class="ust-check-label"><input type="checkbox" class="ust-check"> USt</label>
            <div class="ust-details hidden">
                <input type="number" name="Prozent" placeholder="Prozent">
                <input type="number" placeholder="Steuerbetrag">
            </div>
        </div>
        <h4>Aufgabekosten</h4>
        <div class="category" data-category="aufgabekosten">
            <input type="text" placeholder="Text">
            <input type="number" placeholder="Betrag eingeben">
            <label class="ust-check-label"><input type="checkbox" class="ust-check"> USt</label>
            <div class="ust-details hidden">
                <input type="number" name="Prozent" placeholder="Prozent">
                <input type="number" placeholder="Steuerbetrag">
            </div>
        </div>
    </div>
    <div class="category">
        <input type="submit" value="Berechnen">
    </div>
    <div class="category">
        <input type="button" name ="saveButton" id="saveButton" value="Save as XML">
        <label for="importButton" class="custom-file-upload">
            Datei hochladen
        </label>
        <input type="file" name="importButton" id="importButton" accept=".xml" style="display: none;" />        
    </div>
</form>
<br><br><br>
<footer>
    <p>&copy; 2024 Andreas Pany</p>
</footer>  
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Function to toggle sections based on dropdown value
        function toggleSections() {
            var value = document.getElementById('berechnung').value;
            var uebergangSection = document.getElementById('uebergang');
            var aufgabeSection = document.getElementById('aufgabe');

            if (value === 'uebergang') {
                uebergangSection.style.display = 'block';
                aufgabeSection.style.display = 'none';
            } else if (value === 'aufgabe') {
                uebergangSection.style.display = 'none';
                aufgabeSection.style.display = 'block';
            } else if (value === 'beides') {
                uebergangSection.style.display = 'block';
                aufgabeSection.style.display = 'block';
            }
        }

        // Initial call to set the correct display state based on the dropdown
        toggleSections();

        // Event listener for the dropdown change
        document.getElementById('berechnung').addEventListener('change', toggleSections);

        // Function to handle USt checkbox change
        function handleCheckboxChange() {
            var ustDetails = this.closest('.category').querySelector('.ust-details');
            ustDetails.classList.toggle('hidden', !this.checked);
        }

        // Attach event listeners to USt checkboxes initially present in the form
        document.querySelectorAll('.ust-check').forEach(checkbox => {
            checkbox.addEventListener('change', handleCheckboxChange);
        });

        // Function to update event listeners for text inputs and USt checkboxes
        function updateEventListeners() {
            document.querySelectorAll('.category').forEach(function(categoryContainer) {
                var textInputs = categoryContainer.querySelectorAll('input[type="text"]');
                textInputs.forEach(input => {
                    input.removeEventListener('input', handleTextInput);
                });

                var lastTextInput = textInputs[textInputs.length - 1];
                if (lastTextInput) {
                    lastTextInput.addEventListener('input', handleTextInput);
                }
            });
        }

        // Update the handleTextInput function to call attachCheckboxEventListeners after adding a new row
        function handleTextInput() {
            var category = this.closest('.category').getAttribute('data-category');
            var isLastRow = !this.closest('.category').nextElementSibling || this.closest('.category').nextElementSibling.getAttribute('data-category') !== category;

            if (isLastRow && this.value.trim() !== '') {
                var newRow = this.closest('.category').cloneNode(true);
                newRow.setAttribute('data-category', category); // Ensure cloned row retains original data-category
                newRow.querySelectorAll('input[type="text"], input[type="number"]').forEach(input => input.value = '');
                newRow.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                    checkbox.checked = false;
                });
                newRow.querySelector('.ust-details').classList.add('hidden');
                this.closest('.category').parentNode.insertBefore(newRow, this.closest('.category').nextSibling);
                updateEventListeners();
                attachCheckboxEventListeners(); // Attach event listeners for checkboxes in the newly added row
            }
        }

        // Initial setup of event listeners for existing rows
        updateEventListeners();

        // Event listener for form submission
        document.getElementById('calcForm').addEventListener('submit', function(e) {
            e.preventDefault();
            alert('Berechnung abgeschlossen!');
        });

        function serializeToXML() {
            let xml = '<?xml version="1.0" encoding="UTF-8"?>\n<FormData>\n';

            // Serialize Grunddaten
            xml += '<Grunddaten>\n';
            document.querySelectorAll('#calcForm .category:not([data-category]) input').forEach((input) => {
                // Assuming each input has an ID that can be used as the element name
                const tagName = input.id || input.getAttribute('name');
                const value = input.type === 'checkbox' ? input.checked : input.value; // Adjust for checkboxes if needed
                xml += `  <${tagName}>${value}</${tagName}>\n`;
            });
            xml += '</Grunddaten>\n';

            // Object to keep track of category counts
            const categoryCounts = {};

            // Iterate over all categories
            document.querySelectorAll('.category[data-category]').forEach((categoryDiv) => {
                const category = categoryDiv.getAttribute('data-category');

                // Increment or initialize the count for this category
                if (!categoryCounts[category]) {
                    categoryCounts[category] = 1;
                } else {
                    categoryCounts[category]++;
                }

                const setName = `set${categoryCounts[category]}`;
                // Start the category and set only if it's the first set
                if (categoryCounts[category] === 1) {
                    xml += `<${category}>\n`;
                }
                xml += `  <${setName}>\n`;

                categoryDiv.querySelectorAll('input[type="text"], input[type="number"], input[type="checkbox"]').forEach((input, index) => {
                    const entryName = `entry${index + 1}`;
                    let value = input.type === 'checkbox' ? input.checked : input.value;
                    xml += `    <${entryName}>${value}</${entryName}>\n`;
                });

                xml += `  </${setName}>\n`;
                // Close the category tag only after the last set
                if (categoryCounts[category] === document.querySelectorAll(`.category[data-category="${category}"]`).length) {
                    xml += `</${category}>\n`;
                }
            });

            xml += '</FormData>';
            return xml;
        }

        function saveAsXML() {
            var xmlData = serializeToXML();
            var blob = new Blob([xmlData], { type: 'application/xml' });
            var url = URL.createObjectURL(blob);

            var a = document.createElement('a');
            a.href = url;
            a.download = 'formData.xml';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        document.getElementById('saveButton').addEventListener('click', function() {
            saveAsXML();
        });

        function handleXMLImport(xmlData) {
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(xmlData, "text/xml");
            // Handle Grunddaten
            handleGrunddaten(xmlDoc);
            // Handle categories
            handleCategories(xmlDoc);
            // Attach event listeners for checkboxes
            attachCheckboxEventListeners();
            updateEventListeners();
        }

        function handleGrunddaten(xmlDoc) {
            const grunddaten = xmlDoc.getElementsByTagName("Grunddaten")[0];
            if (grunddaten) {
                Array.from(grunddaten.children).forEach(input => {
                    const element = document.getElementById(input.tagName);
                    if (element) {
                        element.value = input.textContent;
                    }
                });
            }
        }

        function handleCategories(xmlDoc) {
            const categories = xmlDoc.getElementsByTagName("FormData")[0].children;
            Array.from(categories).forEach(category => {
                if (category.tagName !== "Grunddaten") {
                    createAndPopulateFields(category.tagName, Array.from(category.children));
                }
            });
        }

        function createAndPopulateFields(categoryName, sets) {
            // Clear existing fields except the first set
            clearExistingInputFields(categoryName);
            // Iterate over sets and populate data
            sets.forEach((set, index) => {
                // Ensure the input row exists
                ensureInputRowsExist(categoryName, index);
                // Populate the input fields
                const entries = set.children;
                populateFields(categoryName, index, entries);
            });
        }

        function clearExistingInputFields(category) {
            // Reset only the inputs within the category
            const categories = document.querySelectorAll(`.category[data-category="${category}"]`);
            if (categories.length > 1) {
                categories.forEach((category, index) => {
                    if (index > 0) {
                        category.remove();
                    } else {
                        resetFields(category);
                    }
                });
            } else if (categories.length === 1) {
                resetFields(categories[0]);
            }
        }

        function resetFields(category) {
            category.querySelectorAll('input[type="text"], input[type="number"]').forEach(input => input.value = '');
            category.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = false;
                checkbox.dispatchEvent(new Event('change'));
            });
        }

        function ensureInputRowsExist(categoryName, setIndex) {
            let categoryContainers = document.querySelectorAll(`.category[data-category="${categoryName}"]`);
            // If there are not enough containers for the data, create them
            if (categoryContainers.length <= setIndex) {
                // Find the last container of the same category
                let lastCategoryContainer = categoryContainers[categoryContainers.length - 1];
                // Clone and insert a new row after the last container of the same category
                let newCategoryContainer = lastCategoryContainer.cloneNode(true);
                resetFields(newCategoryContainer);
                lastCategoryContainer.parentNode.insertBefore(newCategoryContainer, lastCategoryContainer.nextSibling);

                // Update the categoryContainers NodeList since we've added a new container
                categoryContainers = document.querySelectorAll(`.category[data-category="${categoryName}"]`);
            }
        }

        function populateFields(categoryName, setIndex, entries) {
            const categoryContainers = document.querySelectorAll(`.category[data-category="${categoryName}"]`);

            // Create a new row if necessary
            if (setIndex >= categoryContainers.length) {
                const categoryContainer = document.querySelector(`#uebergang .category[data-category="${categoryName}"]`);
                const newRow = categoryContainer.cloneNode(true);
                resetFields(newRow);
                categoryContainer.parentNode.appendChild(newRow);
                updateEventListenersForNewRow(newRow); // Attach event listeners to the new row
            }

            const currentContainer = categoryContainers[setIndex];
            const ustCheck = currentContainer.querySelector('.ust-check');
            const ustDetails = currentContainer.querySelector('.ust-details');
            const ustDetailsInputs = ustDetails.querySelectorAll('input');

            Array.from(entries).forEach((entry) => {
                switch (entry.tagName.toLowerCase()) {
                    case 'entry3':
                        ustCheck.checked = entry.textContent === 'true';
                        ustDetails.classList.toggle('hidden', !ustCheck.checked); // Show or hide details based on checkbox
                        break;
                    case 'entry4':
                        ustDetailsInputs[0].value = entry.textContent; // Assuming the first USt details input is for Prozent
                        break;
                    case 'entry5':
                        ustDetailsInputs[1].value = entry.textContent; // Assuming the second USt details input is for Steuerbetrag
                        break;
                    default:
                        // Handle other entries
                        const inputIndex = parseInt(entry.tagName.substring(5)) - 1;
                        const input = currentContainer.querySelectorAll('input[type="text"], input[type="number"]')[inputIndex];
                        if (input) {
                            input.value = entry.textContent;
                        }
                        break;
                }
            });
        }

        function findInputForEntry(categoryContainer, entry, entryIndex) {
            // Assume that each set has 5 inputs and the 3rd one is the checkbox
            const inputs = categoryContainer.querySelectorAll('input');
            let input;
            if (entry.tagName.toLowerCase().includes('entry3')) {
                input = categoryContainer.querySelector('.ust-check'); // Checkbox
            } else if (entry.tagName.toLowerCase().includes('entry4') || entry.tagName.toLowerCase().includes('entry5')) {
                // Find the USt details inputs by using the index offset
                input = categoryContainer.querySelector('.ust-details').children[entryIndex - 4];
            } else {
                input = inputs[entryIndex]; // Other text and number inputs
            }
            return input;
        }

        function attachCheckboxEventListeners() {
            document.querySelectorAll('.ust-check').forEach(checkbox => {
                checkbox.addEventListener('change', handleCheckboxChange);
            });
        }
        // Update the updateEventListenersForNewRow function to call attachCheckboxEventListeners
        function updateEventListenersForNewRow(newRow) {
            attachCheckboxEventListeners(); // Attach event listeners for checkboxes
            const ustCheckbox = newRow.querySelector('.ust-check');
            if (ustCheckbox) {
                ustCheckbox.addEventListener('change', handleCheckboxChange);
            }
            // Add other event listeners if necessary
        }

        function handleCheckboxChange() {
            const ustDetails = this.closest('.category').querySelector('.ust-details');
            if (this.checked) {
                ustDetails.classList.remove('hidden');
            } else {
                ustDetails.classList.add('hidden');
            }
        }

        document.getElementById('importButton').addEventListener('change', function() {
            const file = this.files[0];
            const reader = new FileReader();
            reader.onload = function(e) {
                const xmlData = e.target.result;
                handleXMLImport(xmlData);
            };
            reader.readAsText(file);
        });
    });
</script>
</body>
</html>
